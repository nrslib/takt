name: CC Resolve

on:
  issue_comment:
    types: [created]

jobs:
  resolve:
    # Uncomment to allow organization members or collaborators:
    # || github.event.comment.author_association == 'MEMBER'
    # || github.event.comment.author_association == 'COLLABORATOR'
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/resolve') &&
      github.event.comment.author_association == 'OWNER'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Acknowledge
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content=rocket
          gh pr comment ${{ github.event.issue.number }} --repo ${{ github.repository }} \
            --body "ğŸš€ cc-resolve started: [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if fork PR
        id: pr
        run: |
          PR_REPO=$(gh pr view ${{ github.event.issue.number }} --repo ${{ github.repository }} \
            --json headRepositoryOwner,headRepository \
            --jq '"\(.headRepositoryOwner.login)/\(.headRepository.name)"')
          BRANCH=$(gh pr view ${{ github.event.issue.number }} --repo ${{ github.repository }} \
            --json headRefName -q .headRefName)
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          if [ "$PR_REPO" != "${{ github.repository }}" ]; then
            echo "::error::Fork PR ã¯ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚contributor å´ã§è§£æ±ºã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.branch }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge main (detect conflicts)
        id: merge
        run: |
          git fetch origin main
          if git merge origin/main --no-edit 2>/dev/null; then
            echo "conflicts=false" >> "$GITHUB_OUTPUT"
          else
            echo "conflicts=true" >> "$GITHUB_OUTPUT"
          fi

          # ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’æ¤œå‡º
          STALE_MARKERS=$(grep -rl '<<<<<<<' --include='*.ts' --include='*.js' --include='*.json' --include='*.yaml' --include='*.yml' --include='*.md' . 2>/dev/null | grep -v node_modules | grep -v .git || echo "")
          if [ -n "$STALE_MARKERS" ]; then
            echo "stale_markers=true" >> "$GITHUB_OUTPUT"
            {
              echo "stale_marker_files<<MARKER_EOF"
              echo "$STALE_MARKERS"
              echo "MARKER_EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "stale_markers=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Resolve
        run: |
          claude -p --dangerously-skip-permissions "$(cat <<'PROMPT'
          ã“ã®PRã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ±ºã—ã¦ãã ã•ã„ã€‚

          ## çŠ¶æ³åˆ¤å®š

          ã¾ãšç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®2ã¤ã‚’ã™ã¹ã¦ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚

          1. `git status` ã§ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆï¼ˆUnmerged pathsï¼‰ã®æœ‰ç„¡ã‚’ç¢ºèª
          2. ãƒ•ã‚¡ã‚¤ãƒ«ä¸­ã«ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼ï¼ˆ`<<<<<<<`ï¼‰ãŒæ®‹ã£ã¦ã„ãªã„ã‹ `grep -r '<<<<<<<' --include='*.ts' --include='*.js' --include='*.json' .` ã§ç¢ºèª

          **é‡è¦**: git status ãŒã‚¯ãƒªãƒ¼ãƒ³ã§ã‚‚ã€ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼ãŒãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚‹ã€‚å¿…ãš grep ã§ç¢ºèªã™ã‚‹ã“ã¨ã€‚

          ã©ã¡ã‚‰ã‚‚è©²å½“ã—ãªã‘ã‚Œã°ã€Œã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãªã—ã€ã¨å ±å‘Šã—ã¦çµ‚äº†ã€‚

          ---

          ## ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±º

          Git merge/rebase/cherry-pick ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã€ãŠã‚ˆã³ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«æ®‹å­˜ã™ã‚‹ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’ã€å·®åˆ†åˆ†æã«åŸºã¥ã„ã¦è§£æ±ºã™ã‚‹ã€‚

          **åŸå‰‡: å·®åˆ†ã‚’èª­ã¿ã€ç–‘ã„ã€åˆ¤æ–­æ ¹æ‹ ã‚’æ›¸ã„ã¦ã‹ã‚‰è§£æ±ºã™ã‚‹ã€‚å¦„ä¿¡çš„ã«ç‰‡æ–¹ã‚’æ¡ç”¨ã—ãªã„ã€‚**

          ### 1. ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹

          ```bash
          git status
          ```

          - merge / rebase / cherry-pick ã®ã©ã‚ŒãŒé€²è¡Œä¸­ã‹ç‰¹å®šã™ã‚‹
            - `.git/MERGE_HEAD` ãŒã‚ã‚Œã° merge
            - `.git/rebase-merge/` ãŒã‚ã‚Œã° rebase
            - `.git/CHERRY_PICK_HEAD` ãŒã‚ã‚Œã° cherry-pick

          ### 2. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠŠæ¡ã™ã‚‹

          ä»¥ä¸‹ã‚’**ä¸¦åˆ—ã§**å®Ÿè¡Œ:

          - `git log --oneline HEAD -5` ã§ HEAD å´ï¼ˆç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒï¼‰ã®æœ€è¿‘ã®å¤‰æ›´ã‚’ç¢ºèª
          - `git log --oneline MERGE_HEAD -5` ã§å–ã‚Šè¾¼ã¿å´ã®æœ€è¿‘ã®å¤‰æ›´ã‚’ç¢ºèªï¼ˆmerge ã®å ´åˆï¼‰
          - ä¸¡ãƒ–ãƒ©ãƒ³ãƒã®é–¢ä¿‚æ€§ï¼ˆã©ã¡ã‚‰ãŒãƒ™ãƒ¼ã‚¹ã§ã©ã¡ã‚‰ãŒæ–°ã—ã„ã‹ï¼‰ã‚’ç†è§£ã™ã‚‹

          ### 3. ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ—æŒ™ã™ã‚‹

          ```bash
          git diff --name-only --diff-filter=U
          ```

          åŠ ãˆã¦ã€ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å¯¾è±¡ã«å«ã‚ã‚‹:
          ```bash
          grep -rl '<<<<<<<' --include='*.ts' --include='*.js' --include='*.json' . | grep -v node_modules
          ```

          ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã¨ç¨®é¡ï¼ˆã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ / è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« / ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ç­‰ï¼‰ã‚’å ±å‘Šã™ã‚‹ã€‚

          ### 4. å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æã™ã‚‹

          **ã“ã“ãŒæ ¸å¿ƒã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«ä»¥ä¸‹ã‚’å¿…ãšå®Ÿè¡Œã™ã‚‹ã€‚çœç•¥ã—ãªã„ã€‚**

          1. ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’èª­ã‚€ï¼ˆã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼ä»˜ãã®çŠ¶æ…‹ï¼‰
          2. å„ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ`<<<<<<<` ã€œ `>>>>>>>`ï¼‰ã«ã¤ã„ã¦:
             - HEAD å´ã®å†…å®¹ã‚’å…·ä½“çš„ã«èª­ã‚€
             - theirs å´ã®å†…å®¹ã‚’å…·ä½“çš„ã«èª­ã‚€
             - å·®åˆ†ãŒä½•ã‚’æ„å‘³ã™ã‚‹ã‹åˆ†æã™ã‚‹ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ï¼Ÿãƒªãƒ•ã‚¡ã‚¯ã‚¿ï¼Ÿæ©Ÿèƒ½è¿½åŠ ï¼Ÿå‹å¤‰æ›´ï¼Ÿï¼‰
             - åˆ¤æ–­ã«è¿·ã†å ´åˆã¯ `git log --oneline -- {file}` ã§å¤‰æ›´å±¥æ­´ã‚’ç¢ºèªã™ã‚‹
          3. **åˆ¤æ–­ã‚’æ›¸ã**ï¼ˆä»¥ä¸‹ã®å½¢å¼ã§å¿…ãšå‡ºåŠ›ã™ã‚‹ã“ã¨ï¼‰:

          ```markdown
          ### ãƒ•ã‚¡ã‚¤ãƒ«: path/to/file.ts

          #### ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆ 1 (L30-45)
          - HEAD å´: {å…·ä½“çš„ãªå†…å®¹ã‚’æ›¸ã}
          - theirs å´: {å…·ä½“çš„ãªå†…å®¹ã‚’æ›¸ã}
          - åˆ†æ: {å·®åˆ†ãŒä½•ã‚’æ„å‘³ã™ã‚‹ã‹}
          - åˆ¤æ–­: {HEAD / theirs / ä¸¡æ–¹çµ±åˆ} ã‚’æ¡ç”¨ï¼ˆ{ç†ç”±}ï¼‰
          ```

          **ç–‘ã†ã¹ããƒã‚¤ãƒ³ãƒˆ:**
          - ã€Œã€‡ã€‡å´ãŒæ–°ã—ã„ã‹ã‚‰ã€ã ã‘ã§åˆ¤æ–­ã—ã¦ã„ãªã„ã‹ï¼Ÿ HEAD å´ã«ç‹¬è‡ªã®æ„å›³ã‚ã‚‹å¤‰æ›´ã¯ãªã„ã‹ï¼Ÿ
          - theirs ã‚’æ¡ç”¨ã™ã‚‹ã¨ã€HEAD å´ã§ã—ã‹è¡Œã£ã¦ã„ãªã„ä½œæ¥­ãŒæ¶ˆãˆãªã„ã‹ï¼Ÿ
          - ä¸¡æ–¹ã®å¤‰æ›´ã‚’çµ±åˆã™ã¹ãã‚±ãƒ¼ã‚¹ã§ã¯ãªã„ã‹ï¼Ÿ
          - package-lock.json ã®ã‚ˆã†ãªæ©Ÿæ¢°ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ„å‘³ã‚’ç¢ºèªã—ãŸã‹ï¼Ÿ

          ### 5. è§£æ±ºã‚’å®Ÿæ–½ã™ã‚‹

          ã‚¹ãƒ†ãƒƒãƒ—4ã®åˆ†æçµæœã«åŸºã¥ã„ã¦è§£æ±ºã™ã‚‹:

          - ç‰‡æ–¹æ¡ç”¨ãŒæ˜ç¢ºãªå ´åˆ: `git checkout --ours {file}` / `git checkout --theirs {file}` ã‚’ä½¿ã£ã¦ã‚ˆã„ï¼ˆ**åˆ†ææ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿**ï¼‰
          - ä¸¡æ–¹ã®å¤‰æ›´ã‚’çµ±åˆã™ã‚‹å ´åˆ: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’é™¤å»ã—ã€ä¸¡æ–¹ã®å†…å®¹ã‚’é©åˆ‡ã«çµåˆã™ã‚‹
          - è§£æ±ºã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `git add {file}` ã§ãƒãƒ¼ã‚¯ã™ã‚‹

          è§£æ±ºå¾Œã€`<<<<<<<` ã‚’æ¤œç´¢ã—ã€ãƒãƒ¼ã‚«ãƒ¼ã®å–ã‚Šæ®‹ã—ãŒãªã„ã‹ç¢ºèªã™ã‚‹ã€‚

          ---

          ## æ³¢åŠå½±éŸ¿ç¢ºèª

          **ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ±ºã—ãŸã ã‘ã§ã¯çµ‚ã‚ã‚‰ãªã„ã€‚** å¯¾è±¡å¤–ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚‚å½±éŸ¿ãŒå‡ºã¦ã„ãªã„ã‹æ¤œè¨¼ã™ã‚‹ã€‚

          - ãƒ“ãƒ«ãƒ‰ç¢ºèªï¼ˆ`npm run build`ã€`./gradlew build` ç­‰ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿œã˜ã¦ï¼‰
          - ãƒ†ã‚¹ãƒˆç¢ºèªï¼ˆ`npm test`ã€`./gradlew test` ç­‰ï¼‰
          - å¯¾è±¡å¤–ãƒ•ã‚¡ã‚¤ãƒ«ãŒã€å¤‰æ›´ã¨çŸ›ç›¾ã—ã¦ã„ãªã„ã‹ç¢ºèªã™ã‚‹
            - ä¾‹: é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£ã‚’å¤‰æ›´ã—ãŸã®ã«ã€ãƒ†ã‚¹ãƒˆãŒæ—§ã‚·ã‚°ãƒãƒãƒ£ã‚’æœŸå¾…ã—ã¦ã„ã‚‹
            - ä¾‹: import ãƒ‘ã‚¹ã‚’å¤‰æ›´ã—ãŸã®ã«ã€åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—§ãƒ‘ã‚¹ã‚’å‚ç…§ã—ã¦ã„ã‚‹

          å•é¡ŒãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯ã“ã“ã§ä¿®æ­£ã™ã‚‹ã€‚

          ---

          ## çµæœã‚’å ±å‘Šã™ã‚‹

          å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æ±ºçµæœã‚’ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã§å ±å‘Šã™ã‚‹:

          ```markdown
          ## ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºã‚µãƒãƒªãƒ¼

          | ãƒ•ã‚¡ã‚¤ãƒ« | ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ•° | æ¡ç”¨ | ç†ç”± |
          |---------|-------------|------|------|
          | path/to/file.ts | 2 | theirs | ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ |

          æ³¢åŠä¿®æ­£: {å¯¾è±¡å¤–ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£å†…å®¹ã€‚ãªã‘ã‚Œã°ã€Œãªã—ã€}
          ãƒ“ãƒ«ãƒ‰: OK / NG
          ãƒ†ã‚¹ãƒˆ: OK / NG ({passed}/{total})
          ```

          ---

          ## çµ¶å¯¾åŸå‰‡

          - **å·®åˆ†ã‚’èª­ã¾ãšã«è§£æ±ºã—ãªã„ã€‚** ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ç¢ºèªã›ãšã« `--ours` / `--theirs` ã‚’é©ç”¨ã—ãªã„
          - **ç›²å¾“ã—ãªã„ã€‚** HEAD å´ã«ç‹¬è‡ªã®æ„å›³ãŒãªã„ã‹å¿…ãšç–‘ã†
          - **åˆ¤æ–­æ ¹æ‹ ã‚’çœç•¥ã—ãªã„ã€‚** å„ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã«ã€Œä½•ãŒãƒ»ãªãœãƒ»ã©ã¡ã‚‰ã‚’ã€ã®3ç‚¹ã‚’æ›¸ã
          - **æ³¢åŠã‚’ç¢ºèªã™ã‚‹ã€‚** å¯¾è±¡å¤–ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆã§æ¤œè¨¼ã™ã‚‹

          ## ç¦æ­¢äº‹é …

          - åˆ†æãªã—ã§ `git checkout --ours .` / `git checkout --theirs .` ã‚’å®Ÿè¡Œã—ãªã„
          - ã€Œã¨ã‚Šã‚ãˆãšç‰‡æ–¹ã€ã§å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬è§£æ±ºã—ãªã„
          - ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼ (`<<<<<<<`) ãŒæ®‹ã£ãŸã¾ã¾ã«ã—ãªã„
          - `git merge --abort` ã‚’å®Ÿè¡Œã—ãªã„
          PROMPT
          )" --verbose
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push
        run: |
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "fix: resolve merge conflicts"
          fi
          AHEAD=$(git rev-list --count origin/${{ steps.pr.outputs.branch }}..HEAD 2>/dev/null || echo "0")
          if [ "$AHEAD" -gt 0 ]; then
            echo "Pushing $AHEAD commit(s)"
            git push
          else
            echo "Nothing to push"
          fi

      - name: Report result
        if: always()
        run: |
          PR_NUMBER=${{ github.event.issue.number }}
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          if [ "${{ job.status }}" = "success" ]; then
            gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body "âœ… cc-resolve completed. [View logs](${RUN_URL})"
          else
            gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body "âŒ cc-resolve failed. [View logs](${RUN_URL})"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
